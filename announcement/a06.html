<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cipher/Decipher Announcement</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .container {
            max-width: 600px;
            margin: auto;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input[type="text"],
        textarea {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        button {
            padding: 10px 15px;
            background-color: #007BFF;
            color: #fff;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .output {
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border: 1px solid #ced4da;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            position: relative;
        }
        .copy-button, .download-button {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            background-color: #28a745;
            color: #fff;
            border: none;
            cursor: pointer;
        }
        .download-button {
            right: 120px;
            background-color: #ffc107;
        }
        .copy-button:hover {
            background-color: #218838;
        }
        .download-button:hover {
            background-color: #e0a800;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Decipher Announcement</h1>
    <div class="form-group">
        <label for="key">Key (Hex):</label>
        <input type="text" id="key">
    </div>
    <button onclick="decipherFile()">Decipher</button>

    <h1>Cipher Text</h1>
    <div class="form-group">
        <label for="plainText">Plain Text:</label>
        <textarea id="plainText" rows="4"></textarea>
    </div>
    <button onclick="cipherText()">Cipher</button>

    <div class="output" id="output">
        <button class="copy-button" onclick="copyToClipboard()">Copy to Clipboard</button>
        <button class="download-button" onclick="downloadAsFile()">Download as ciphered.txt</button>
        <pre id="outputContent"></pre>
    </div>
</div>

<script>
    function decipherFile() {
        const keyHex = document.getElementById('key').value;
        const defaultFilePath = './data_ciphered.txt'; // Updated path for the same directory

        if (!keyHex) {
            alert('Please provide the key.');
            return;
        }

        try {
            const response = await fetch(defaultFilePath);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const cipheredDataHex = await response.text();
            const key = CryptoJS.enc.Hex.parse(keyHex);
            const iv = CryptoJS.enc.Hex.parse(cipheredDataHex.slice(0, 32)); // IV is the first 32 hex characters (16 bytes)
            const encrypted = CryptoJS.enc.Hex.parse(cipheredDataHex.slice(32));

            const decrypted = CryptoJS.AES.decrypt({ ciphertext: encrypted }, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
            const plaintext = decrypted.toString(CryptoJS.enc.Utf8);

            document.getElementById('outputContent').innerText = plaintext || 'Decryption failed, invalid key or data.';
        } catch (error) {
            console.error('Error reading the file:', error);
            document.getElementById('outputContent').innerText = 'Error reading the file. Please ensure the file exists and the path is correct.';
        }
    }

    function cipherText() {
        const keyHex = document.getElementById('key').value;
        const plainText = document.getElementById('plainText').value;

        if (!keyHex || !plainText) {
            alert('Please provide both the key and the plain text.');
            return;
        }

        const key = CryptoJS.enc.Hex.parse(keyHex);
        const iv = CryptoJS.lib.WordArray.random(16); // Generate a random IV

        const encrypted = CryptoJS.AES.encrypt(plainText, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
        const cipheredData = iv.concat(encrypted.ciphertext).toString(CryptoJS.enc.Hex);

        document.getElementById('outputContent').innerText = cipheredData;
    }

    function copyToClipboard() {
        const outputContent = document.getElementById('outputContent').innerText;
        const tempTextArea = document.createElement('textarea');
        tempTextArea.value = outputContent;
        document.body.appendChild(tempTextArea);
        tempTextArea.select();
        document.execCommand('copy');
        document.body.removeChild(tempTextArea);
        alert('Copied to clipboard!');
    }

    function downloadAsFile() {
        const outputContent = document.getElementById('outputContent').innerText;
        const blob = new Blob([outputContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = 'ciphered.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
</script>

</body>
</html>
